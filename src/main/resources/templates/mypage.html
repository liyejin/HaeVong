<!DOCTYPE html>
<html
  lang="en"
  xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/reset.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/mypage.css" />
    <script src="/js/components/modal-alert.js" defer></script>
    <script src="/js/components/modal-panel.js" defer></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="/js/user/calender.js" defer></script> -->
    <script defer>
      window.addEventListener("load", function () {
        let mypageCategory = document.querySelector(".mypageCategory");

        let modalAlert = document.querySelector("modal-alert");
        let modalPanel = document.querySelector("modal-panel");
        let profileImgInput = document.querySelector("#profile-img-input");
        let nicknameInput = document.getElementById("#profile-nickname-input");
        let myPostPlusIcon = document.querySelector(".mypage_mypost_title");
        let profileEditBtn = document.querySelector("#profile-edit-btn");
        let getId = document.querySelector(".get-id");
        let profileImg = document.querySelector(".profile-img");

        // ë¹„íšŒì› ìƒíƒœ ì‹œ ë¡œê·¸ì¸ í›„ ì´ìš© ëª¨ë‹¬
        mypageCategory.onclick = function (e) {
          if (!mypageCategory.classList.contains("isAnonymous")) return;
          e.preventDefault();
          modalAlert.show(true);
        };

        myPostPlusIcon.onclick = function (e) {
          if (!myPostPlusIcon.classList.contains("isAnonymous")) return;

          e.preventDefault();
          modalAlert.show(true);
        };

        // íšŒì› ë¡œê·¸ì¸ ì‹œ í”„ë¡œí•„ ìˆ˜ì • ëª¨ë‹¬
        profileEditBtn.onclick = function (e) {
          modalPanel.show(true);
        };

        profileImgInput.oninput = function (e) {
          let file = e.target.files[0];
          let reader = new FileReader();
          reader.onload = function (event) {
            profileImg.src = event.target.result;
          };
          reader.readAsDataURL(file);
        };

        let btnCancel = document.querySelector(".btn-cancel");
        btnCancel.onclick = function (e) {
          modalPanel.show(false);
        };

        let btnSubmmit = document.querySelector(".btn-submmit");
        btnSubmmit.onclick = () => {
          // í”„ë¡œí•„ ì‚¬ì§„ ë³€ê²½
          let profileImgInput = document.querySelector("#profile-img-input");

          let file = profileImgInput.files[0];
          if (file) {
            let formData = new FormData();

            formData.append("file", file);

            fetch(`/api/file/user/${getId.value}/image`, {
              method: "PUT",
              body: formData,
            })
              .then((response) => response.text())
              .then((url) => {
                let imgTag = document.querySelector(
                  ".user-profile-image-log-in"
                );
                imgTag.src = url;
              });
          }

          // ë‹‰ë„¤ì„ ë³€ê²½
          let inputNickname = document.querySelector(
            "#profile-nickname-input"
          ).value;
          let userNickname = document.querySelector(".mypage_profile_name")
            .dataset.nickname;

          let formData = new FormData();
          formData.append("userNickname", inputNickname);

          if (inputNickname != userNickname) {
            fetch(`/api/user/${getId.value}/nickname`, {
              method: "PUT",
              body: formData,
            })
              .then((response) => response.json())
              .then((user) => {
                let userNicknameTag = document.querySelector(
                  ".mypage_profile_name"
                );
                userNicknameTag.textContent = user.nickname;
                setTimeout(() => {
                  modalPanel.show(false);
                }, 250);
              });
          }
        };

        // ------------------------ ê°€ì…ì¼ / ë´‰ì‚¬íšŸìˆ˜ ì¹´ìš´íŠ¸ -----
        // ê°€ì…ì¼ë¡œë¶€í„° ê²½ê³¼í•œ ì¼ìˆ˜ ê³„ì‚°
        let signupDateString = document.querySelector(".get-signup-date").value;
        let signupDate = new Date(signupDateString);
        let currentDate = new Date();
        let timeDiff = Math.abs(currentDate.getTime() - signupDate.getTime());
        let daysCount = Math.ceil(timeDiff / (1000 * 3600 * 24));

        // HTMLì—ì„œ ì¼ ìˆ˜ ì—…ë°ì´íŠ¸
        let daysCountElement = document.getElementById("daysCount");
        daysCountElement.textContent = daysCount;
      });
    </script>
    <title>ë§ˆì´í˜ì´ì§€</title>
  </head>

  <body>
    <header class="header">
      <div class="header1">
        <a href="/category_main">
          <img src="/img/icon/icon_header_back.png" alt="ë’¤ë¡œê°€ê¸°" />
        </a>
        <div>ë§ˆì´í˜ì´ì§€</div>
        <div></div>
      </div>
    </header>

    <main class="main">
      <!-- ìœ ì € í”„ë¡œí•„ ----------------------------------------------------- -->
      <section class="mypage_profile">
        <input
          sec:authorize="isAuthenticated()"
          class="get-id"
          type="hidden"
          th:value="${user.id}"
        />
        <input
          sec:authorize="isAuthenticated()"
          class="get-signup-date"
          type="hidden"
          th:value="${user.signupDate}"
        />
        <div sec:authorize="isAnonymous()" class="profile_pic">
          <img src="/img/user/nonUserpic.png" />
        </div>

        <div sec:authorize="isAuthenticated()" class="profile_pic">
          <img
            th:src="${user.profilePhoto}"
            class="user-profile-image-log-in"
          />
        </div>

        <div class="profile_txt">
          <p>
            <span sec:authorize="isAnonymous()" class="mypage_profile_name"
              >íšŒì›</span
            >

            <span
              sec:authorize="isAuthenticated()"
              class="mypage_profile_name"
              th:data-nickname="${user.nickname}"
              th:text="${user.nickname}"
              >íšŒì›</span
            ><span> ë‹˜</span>
          </p>
          <button
            sec:authorize="isAuthenticated()"
            id="profile-edit-btn"
          ></button>
          <p class="title">ê°€ì¹˜ìˆëŠ” ì¼ìƒ ê°™ì´ ë§Œë“¤ì–´ìš”!</p>
        </div>
      </section>

      <section class="mypage_guide">
        <a><img src="/img/org/org_guide.png" alt="" /></a>
      </section>

      <!-- ë§ˆì´í˜ì´ì§€ ì¹´í…Œê³ ë¦¬ ----------------------------------------------------- -->

      <section sec:authorize="isAnonymous()" class="mypageCategory isAnonymous">
        <ul>
          <li>
            <a href="#">
              <div>
                <span>ğŸ“<br /></span>
                <span>ì‹ ì²­ê´€ë¦¬</span>
              </div>
            </a>
            <a href="#">
              <div>
                <span>â¤ï¸<br /></span>
                <span>ì°œí•œë´‰ì‚¬</span>
              </div>
            </a>
            <a href="#">
              <div>
                <span>ğŸ“£<br /></span>
                <span>ë‹¬ë ¥</span>
              </div>
            </a>
            <a href="#">
              <div>
                <span>âš™ï¸<br /></span>
                <span>ë‚´ ì •ë³´</span>
              </div>
            </a>
          </li>
        </ul>
      </section>

      <section sec:authorize="isAuthenticated()" class="mypageCategory">
        <ul>
          <li>
            <a href="/user/myapply">
              <div>
                <span>ğŸ“<br /></span>
                <span>ì‹ ì²­ê´€ë¦¬</span>
              </div>
            </a>
            <a href="/user/vol_wish_list">
              <div>
                <span>â¤ï¸<br /></span>
                <span>ì°œí•œë´‰ì‚¬</span>
              </div>
            </a>
            <a href="/user/calender">
              <div>
                <span>ğŸ“£<br /></span>
                <span>ë‹¬ë ¥</span>
              </div>
            </a>
            <a href="/user/myapply">
              <div>
                <span>âš™ï¸<br /></span>
                <span>ë‚´ ì •ë³´</span>
              </div>
            </a>
          </li>
        </ul>
      </section>

      <!-- ë‚˜ì˜ ê²Œì‹œê¸€ ----------------------------------------------------- -->

      <section sec:authorize="isAnonymous()" class="my_post">
        <div class="mypage_mypost_title isAnonymous" id="imageContainer">
          <span>ë‚˜ì˜ ê²Œì‹œê¸€ </span>
          <a href="#"><img src="/img/icon/icon_plus.png" /></a>
        </div>
        <div class="mypage_mypost_img">
          <img src="/img/user/emptyImage.png" alt="ê²Œì‹œê¸€1" />
          <img src="/img/user/emptyImage.png" alt="ê²Œì‹œê¸€1" />
          <img src="/img/user/emptyImage.png" alt="ê²Œì‹œê¸€1" />
        </div>

        <!--  -->
      </section>

      <section sec:authorize="isAuthenticated()" class="my_post">
        <div class="mypage_mypost_title" id="imageContainer">
          <span>ë‚˜ì˜ ê²Œì‹œê¸€ </span>
          <a href="#"><img src="/img/icon/icon_plus.png" /></a>
        </div>
        <div class="mypage_mypost_img">
          <a th:href="${p.id}" th:each="p:${mypic}"
            ><img src="" th:src="${p.url}" alt="ê²Œì‹œê¸€1"
          /></a>
        </div>
      </section>

      <!-- í•´ë´‰ê³¼ í•¨ê»˜í•œì§€ -----------ss------------------------------------------ -->
      <section sec:authorize="isAnonymous()" class="cs">
        <span
          >í•´ë´‰ê³¼ í•¨ê»˜í•´ ì£¼ì„¸ìš” ! ğŸ˜Š<br />
          <a href="/user_signin"> ì§€ê¸ˆ ë¡œê·¸ì¸í•˜ê¸°</a></span
        >
      </section>

      <section sec:authorize="isAuthenticated()" class="cs">
        <span
          ><span th:text="${user.name}">íšŒì›</span>ë‹˜ì´ í•´ë´‰ê³¼ í•¨ê»˜í•œì§€ğŸ’›
          <span id="daysCount"></span>ì¼<br
        /></span>
        <span
          ><span th:text="${user.name}">íšŒì›</span>ë‹˜ì´ í•´ë´‰ì„ í†µí•´ í•¨ê»˜í•œ
          ë´‰ì‚¬ğŸ¤ <span th:text="${countAV}"></span>íšŒ</span
        >
      </section>
      <modal-alert
        class="d-none"
        data-show="false"
        data-title="ì•Œë¦¼"
        data-content="ë¡œê·¸ì¸ í›„ ì´ìš©í•´ ì£¼ì„¸ìš”"
      >
        <div slot="content"></div>
      </modal-alert>

      <modal-panel
        class="d-none"
        data-title="í”„ë¡œí•„ ìˆ˜ì •"
        data-show="false"
        data-submmit="ì ìš©"
      >
        <section class="profile-edit-section" slot="content">
          <form class="profile-edit-form">
            <img
              th:if="${user}"
              th:src="${user.profilePhoto}"
              class="profile-img"
              src="/img/user/nonUserpic.png"
              alt=""
            />
            <div class="img-input-div">
              <label
                for="profile-img-input"
                class="icon icon-plus img-drop-zone"
              ></label>
              <input type="file" alt="ì‚¬ì§„ ë³€ê²½" id="profile-img-input" />
            </div>

            <div sec:authorize="isAuthenticated()" class="nickname-input-div">
              <input
                type="text"
                alt="ë‹‰ë„¤ì„ ë³€ê²½"
                id="profile-nickname-input"
                th:value="${user.nickname}"
              />
              <span>í•œê¸€/ì˜ë¬¸/ìˆ«ì í¬í•¨ 10ì ì´ë‚´</span>
            </div>
          </form>
          <div class="content-command">
            <button class="btn-cancel">ì·¨ì†Œ</button>
            <button type="submit" class="btn-submmit">ì ìš©</button>
          </div>
        </section>
      </modal-panel>
    </main>
    <nav class="nav_list" th:replace="~{inc/nav}"></nav>
  </body>
</html>
